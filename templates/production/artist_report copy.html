{% extends 'main/base.html' %}


{% block bread_crumb %}
    <!-- ============================================================== -->
    <!-- Bread crumb and right sidebar toggle -->
    <!-- ============================================================== -->
    <!-- Daterange picker plugins css -->
    <link href="/static/template/assets/plugins/daterangepicker/daterangepicker.css" rel="stylesheet">
    <link rel='stylesheet' href='/static/third_party/DataTables/DataTables-1.12.1/css/jquery.dataTables.min.css'
          type="text/css"/>
    <link rel='stylesheet' href='/static/third_party/DataTables/Responsive-2.3.0/css/responsive.dataTables.min.css'
          type="text/css"/>
    <link rel='stylesheet' href='/static/third_party/DataTables/Responsive-2.3.0/css/responsive.bootstrap5.min.css'
          type="text/css"/>
    <link rel='stylesheet' href='/static/third_party/DataTables/Buttons-2.2.3/css/buttons.dataTables.min.css'
          type="text/css"/>
    <link rel='stylesheet' href='/static/template/assets/plugins/multiselect/css/multi-select.css'
          type="text/css"/>
    <link rel="stylesheet"
          href="/static/template/assets/plugins/toast-master/css/jquery.toast.css" type="text/css"/>
    <link rel="stylesheet"
          href="/static/third_party/DataTables/custom_css/datables_searchpane.css" type="text/css"/>
    <link rel="stylesheet"
          href="/static/third_party/DataTables/Select-1.4.0/css/select.dataTables.min.css" type="text/css"/>
    <link href="/static/third_party/DataTables/DataTables-1.12.1/css/dataTables.jqueryui.css" rel="stylesheet"
          type="text/css"/>
    <style>
        .form-control {
            color: #fffcfc !important;
        }

        .container-fluid {
            padding: 10px !important;
        }

        .row {
            margin: 0px !important;
        }

        /* An ugly trick to use a filter icon */
        .ui-icon-volume-off.ui-icon-filter {
            -ms-transform: rotate(270deg);
            -webkit-transform: rotate(270deg);
            transform: rotate(270deg);
        }

        .card {
            padding: 10px;
            background: #272c33 !important;
            color: white;
            margin-bottom: 10px !important;
        }

        #filter_div {
            padding: 10px;
            background: #0f0f10 !important;
            color: white;
        }

        .col-lg-12 {
            padding: 0px !important;
        }

        .col-lg-10 {
            padding: 0px !important;
        }

        .card-body {
            padding: 0rem !important;
        }

        .dt-buttons .dt-button {
            border-radius: 4px;
            background: orange;
            color: #ffffff
        }

        table.dataTable tbody tr {
            background-color: #272c33 !important;
            font-size: small;
            font-weight: normal;
        }

        table.dataTable tr.odd {
            background-color: #2b3038 !important;
        }

        table.dataTable td {
            border-bottom: 0.2px !important;
            border-color: grey !important;
        }

        table.dataTable thead {
            color: #f6f5f5;
            font-weight: normal;
            font-size: small;
        }

        #shots_table_length, #shots_table_info, #shots_table_filter {
            color: #a2a1a1 !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 2px;
            background: white;
        }

        tfoot input {
            width: 100% !important;
            padding: 3px !important;
            box-sizing: border-box !important;
        }

        table.dataTable tfoot th, table.dataTable tfoot td {
            padding: 5px;
            border-top: 0px;
        }

        .page-titles {
            padding-bottom: 0px;
        }

        .dataTables_wrapper .dataTables_length select {
            color: #ccc8c8 !important;
            background-color: inherit;
        }

        .dataTables_wrapper .dataTables_filter input {
            color: #dad8d8 !important;
        }

        table.dataTable tbody tr.selected {
            background-color: #315eb1 !important;
            color: white !important;
        }

        label {
            margin-bottom: 0px !important;
        }

        .multiselect-container > li > a > label {
            padding: 4px 20px 3px 20px;
        }

        table.dataTable tbody th, table.dataTable tbody td {
            padding: 7px;
        }

        .column_vis {
            height: 20px;
        }

        /* width */
        ::-webkit-scrollbar {
            width: 10px;
        }

        /* Track */
        ::-webkit-scrollbar-track {
            background: #383f48;
            border-radius: 5px;
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
            background: #2965b9;
            border-radius: 5px;
        }

        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        svg {
            width: 100px;
            height: 100px;
            margin: 20px;
            display: inline-block;
            background-color: #0A0A0A;
        }

        div.dtsp-verticalContainer {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-content: flex-start;
            align-items: flex-start;
        }

        div.dtsp-verticalContainer div.dtsp-verticalPanes,
        div.dtsp-verticalContainer div.container {
            width: 20%;
            flex-grow: 0;
            flex-shrink: 0;
            flex-basis: 0;
        }

        div.dtsp-verticalContainer div.dtsp-verticalPanes {
            flex-grow: 1;
            flex-shrink: 0;
            flex-basis: 26%;
        }

        div.dtsp-verticalPanes {
            margin-right: 10px;
        }

        div.dtsp-title {
            margin-right: 0px !important;
            margin-top: 13px !important;
        }

        input.dtsp-search {
            min-width: 0px !important;
            padding-left: 0px !important;
            margin: 0px !important;
        }

        div.dtsp-verticalContainer div.dtsp-verticalPanes div.dtsp-searchPanes {
            flex-direction: column;
            flex-basis: 0px;
        }

        div.dtsp-verticalContainer div.dtsp-verticalPanes div.dtsp-searchPanes div.dtsp-searchPane {
            flex-basis: 0px;
        }

        div.dtsp-verticalContainer div.container {
            flex-grow: 1;
            flex-shrink: 0;
            flex-basis: 80%;
        }

        div.dtsp-panesContainer {
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 5px;
        }

        #filter_div {
            padding: 10px;
            background: #272c33 !important;
            color: white;
        }

    </style>


    <div class="row page-titles">
        <div class="col-md-6 col-4 float-left">
            <h3 class="text-themecolor mb-0 mt-2">Artist Report</h3>
        </div>
        <div class="col-md-6 col-8">
            <div class="float-right" style="background-color: #e5711d;border-radius: 10px">
                <div class="float-right" style="margin-left: 5px">
                    <button class="btn waves-effect waves-lightfloat-right" title="Export to Excel"
                            onclick="artist_export_to_excel()"><i
                            class="mdi mdi-cloud-download" style="color: white;font-size: large"></i> EXPORT TO EXCEL
                    </button>
                </div>
                {#            TODO: Enable to work on filters#}
                <!--- Filter button --->
                <div class="float-right" style="margin-left: 5px">

                    <button class="column_filter btn waves-effect waves-lightfloat-right" title="Filters"
                            data-toggle="button" aria-pressed="true">
                        <i
                                class="mdi mdi-filter" style="color:white;font-size: large"></i> FILTERS
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div class="row page-titles">

        <div class="col-md-8 col-8 align-self-center">


        </div>
    </div>
    <!-- ============================================================== -->
    <!-- End Bread crumb and right sidebar toggle -->
    <!-- ============================================================== -->
{% endblock bread_crumb %}


{% block content %}
    <div class="container-fluid row">

        <!-- Shots Table View -->
        <div class="col-lg-12" id="task_list_view">
            <div class="card">

                <table id="artist_table" class="table display no-wrap" style="width:100%">


                </table>

            </div>
        </div>
        <div class="col-md-3 col-2 card" id="filter_div"
             style="display: none;height:1000px;overflow-y: auto;margin: 0px;">
            <div class="card">
                <div class="card-body">
                    <div class="dtsp-verticalContainer">
                        <div class="dtsp-verticalPanes">
                        </div>
                        <div class="container">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
{% endblock content %}

{% block page_scripts %}
    <!--OFX Core JavaScript -->
    <script src="/static/ofx/core.js"></script>
    <!-- chartist chart -->
    <!-- <script src="/static/template/assets/plugins/moment/moment.js"></script> -->
    <!-- Date range Plugin JavaScript -->
    <script src="/static/template/assets/plugins/daterangepicker/daterangepicker.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script> -->
    <script src="/static/third_party/DataTables/DataTables-1.12.1/js/jquery.dataTables.min.js"></script>
    <script src="/static/third_party/DataTables/Responsive-2.3.0/js/dataTables.responsive.min.js"></script>
    <script src="/static/third_party/DataTables/Responsive-2.3.0/js/responsive.bootstrap5.min.js"></script>
    <script src="/static/third_party/DataTables/Buttons-2.2.3/js/dataTables.buttons.min.js"></script>
    <script src="/static/third_party/DataTables/Buttons-2.2.3/js/buttons.html5.min.js"></script>
    <script src="/static/third_party/DataTables/Bootstrap-5-5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="/static/third_party/DataTables/custom_js/datatables_searchPane.js"></script>
    <script src="/static/third_party/DataTables/Select-1.4.0/js/dataTables.select.min.js"></script>
    <!-- Bootstrap tether Core JavaScript -->
    <script type="text/javascript">
        let artist_id;
        let s_Date;
        let e_Date;
        let artist_name;
        let rdeptX;

        /*******************************************/
        // Date Ranges
        /*******************************************/
        $('.dateranges').daterangepicker({
            ranges: {
                'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                'This Month': [moment().startOf('month'), moment().endOf('month')],
                'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            },
            locale: {
                format: 'DD/MM/YYYY'
            },
            autoApply: false
        }, function (start, end, label) {
            s_Date = start.format("YYYY-MM-DD");
            e_Date = end.format("YYYY-MM-DD");
        });

        $('#dep_select').on('change', function () {
            const dep = $("#dep_select :selected").text().trim();
            $('#artist_select').empty()
            const all_employee_json = $.ajax({
                type: "GET",
                url: "/api/hrm/employee/?dept=" + dep + "&role=VFX ARTIST",
                dataType: "application/json",
                async: false,
                error: function (xhr, status, err) {
                },
            }).responseText;
            const all_employees = JSON.parse(all_employee_json);
            $('#artist_select').append(`<option value="0">
                                   Artist
                              </option>`);
            all_employees.forEach(function (artist) {
                $('#artist_select').append(`<option value=${artist.id}>
                                   ${artist.fullName}
                              </option>`);
            })
        });

        $('.dateranges').on('apply.daterangepicker', function (ev, picker) {
            artist_id = $('#artist_select').val()
            rdeptX = $("#dep_select :selected").text().trim();
            const artist_name = $("#artist_select :selected").text().trim();
            if (artist_id > 0) {
                artist_table.ajax.url("/api/production/custom/artist_reports/?start_date=" + s_Date + "T00:00:00" + "&end_date=" + e_Date + "T23:59:59" + "&artist_id=" + artist_id,)
                artist_table.load()

            } else if (rdeptX !== "") {
                artist_table.ajax.url("/api/production/custom/artist_reports/?start_date=" + s_Date + "T00:00:00" + "&end_date=" + e_Date + "T23:59:59" + "&dept=" + rdeptX)
                console.log(artist_table.ajax.url())
                artist_table.load()
            } else {
                artist_table.ajax.url("/api/production/custom/artist_reports/?start_date=" + s_Date + "T00:00:00" + "&end_date=" + e_Date + "T23:59:59")
                artist_table.load()
            }
        });


        $(".column_filter").click(function (e) {
            var x = document.getElementById("filter_div");
            if (x.style.display === "none") {
                $('.col-lg-12').addClass('col-lg-9').removeClass('col-lg-12')
                x.style.display = "block";
            } else {
                x.style.display = "none";
                $('.col-lg-9').addClass('col-lg-12').removeClass('col-lg-9')
            }
        });

        $(window).click(function (e) {
            $("#filters-modal").modal('hide');
        });

        function date_change_detected(start, end) {
            s_Date = start.format("YYYY-MM-DD");
            e_Date = end.format("YYYY-MM-DD");
            artist_id = $('#artist_select').val()
            rdeptX = $("#dep_select :selected").text().trim();
            const artist_name = $("#artist_select :selected").text().trim();
            if (artist_id > 0) {
                artist_table.ajax.url("/api/production/custom/artist_reports/?start_date=" + s_Date + "T00:00:00" + "&end_date=" + e_Date + "T23:59:59" + "&artist_id=" + artist_id,)
                artist_table.load()

            } else if (rdeptX !== "") {
                artist_table.ajax.url("/api/production/custom/artist_reports/?start_date=" + s_Date + "T00:00:00" + "&end_date=" + e_Date + "T23:59:59" + "&dept=" + rdeptX)
                console.log(artist_table.ajax.url())
                artist_table.load()
            } else {
                artist_table.ajax.url("/api/production/custom/artist_reports/?start_date=" + s_Date + "T00:00:00" + "&end_date=" + e_Date + "T23:59:59")
                artist_table.load()
            }
        }

        var artist_table = ""
        $(document).ready(function () {
            $(".custom_preloader").hide()
            artist_table = $('#artist_table').DataTable({

                searchPanes: {
                    initCollapsed: true,
                    cascadePanes: true,
                    layout: 'columns-1',
                    controls: false
                },
                dom: '<"dtsp-dataTable"frtip>',
                "searching": true,
                "ajax": {
                    "processing": true,
                    "url": '/api/hrm/employee/',
                    "type": "GET",
                    "dataSrc": "",
                    error: function (xhr, error, code) {
                        console.log(xhr, code);
                    }
                },
                'language': {
                    'infoEmpty': "No records available - Please Select Department and Date Range to view data",
                    'loadingRecords': '&nbsp;',
                    'processing': 'Loading...'
                },
                columns: [
                    {title: "EMPLOYEE NUMBER", data: 'employee_id'},
                    {title: "EMPLOYEE NAME", data: 'fullName'},
                    {title: "DEPARTMENT", data: 'department'},
                    {
                        title: "DOJ", data: 'creation_date',
                        render: function (data, type, row, meta) {
                            return moment(data).format("DD-MM-YYYY");
                        }
                    },
                    {title: "DESIGNATION", data: 'role'},
                    {title: "LEVEL", data: 'grade'},
                    {title: "TARGET MANDAYS/DAY", data: null, "defaultContent": ""},
                    {title: "TARGET MANDAYS FOR SELECTED PERIOD", data: null, "defaultContent": ""},
                    {title: "ACHIEVED MAN DAYS", data: null, "defaultContent": ""},
                    {title: "QUALITY", data: null, "defaultContent": ""},
                    {title: "MISSING ETA", data: null, "defaultContent": ""},
                    {title: "LEAVES", data: null, "defaultContent": ""},
                    {title: "REQUIRED WORKING HOURS", data: null, "defaultContent": ""},
                    {title: "AVAILABLE HOURS", data: null, "defaultContent": ""},
                    {title: "ACTIVE HOURS", data: null, "defaultContent": ""},
                    {title: "COMMENTS", data: null, "defaultContent": ""},

                ],
                select: true,
                order: [[1, 'asc']],
                scrollResize: true,
                scrollX: true,
                scrollCollapse: true,
                buttons: [],
                "paging": true,
                "pageLength": 25,
                "bSortClasses": false,
                stateSave: true,
                deferLoading: 10,
            });

            artist_table.searchPanes()
            $("div.dtsp-verticalPanes").append(artist_table.searchPanes.container());
        });

        function artist_export_to_excel() {
            if (s_Date.length > 0) {
                if (artist_id > 0) {
                    window.location = "/production/artistreports_export/?start_date=" + s_Date + "T00:00:00" + "&end_date=" + e_Date + "T23:59:59" + "&artist_id=" + artist_id
                } else if (rdeptX.length > 0) {
                    window.location = "/production/artistreports_export/?start_date=" + s_Date + "T00:00:00" + "&end_date=" + e_Date + "T23:59:59" + "&dept=" + rdeptX
                } else {
                    window.location = "/production/artistreports_export/?start_date=" + s_Date + "T00:00:00" + "&end_date=" + e_Date + "T23:59:59"
                }
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Please Date Range....',
                })
            }
        }
    </script>
{% endblock page_scripts %}