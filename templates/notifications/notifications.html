{% extends 'main/base.html' %}
{% load static %}
{% block bread_crumb %}

    <link rel='stylesheet' href="{% static 'third_party/DataTables/DataTables-1.12.1/css/jquery.dataTables.min.css' %}"
          type="text/css"/>
    <link rel='stylesheet' href="{% static 'third_party/DataTables/Responsive-2.3.0/css/responsive.dataTables.min.css' %}"
          type="text/css"/>
    <link rel='stylesheet' href="{% static 'third_party/DataTables/Responsive-2.3.0/css/responsive.bootstrap5.min.css' %}"
          type="text/css"/>
    <link rel='stylesheet' href="{% static 'third_party/DataTables/Buttons-2.2.3/css/buttons.dataTables.min.css' %}"
          type="text/css"/>
    <link rel='stylesheet' href="{% static 'template/assets/plugins/multiselect/css/multi-select.css' %}"
          type="text/css"/>
    <link rel="stylesheet"
          href="{% static 'third_party/DataTables/custom_css/datables_searchpane.css' %}" type="text/css"/>
    <link rel="stylesheet"
          href="{% static 'third_party/DataTables/Select-1.4.0/css/select.dataTables.min.css' %}" type="text/css"/>
    <link href="{% static 'third_party/DataTables/DataTables-1.12.1/css/dataTables.jqueryui.css' %}" rel="stylesheet"
          type="text/css"/>
    <link href="{% static 'third_party/DataTables/DateTime-1.1.2/css/dataTables.dateTime.min.css' %}" rel="stylesheet"
          type="text/css"/>
    <link href="{% static 'main/jquery-ui-themes-1.11.1/themes/south-street/jquery-ui.min.css' %}" rel="stylesheet" type="text/css"/>
    <link href="{% static 'main/dataTables.jqueryui.css' %}" rel="stylesheet" type="text/css"/>
    <link rel='stylesheet' href="{% static 'assets/css/style.css' %}" type="text/css"/>
    <style>
        .form-control {
            color: #fffcfc !important;
        }

        .container-fluid {
            padding: 10px !important;
        }

        .row {
            margin: 0px !important;
        }

        /* An ugly trick to use a filter icon */
        .ui-icon-volume-off.ui-icon-filter {
            -ms-transform: rotate(270deg);
            -webkit-transform: rotate(270deg);
            transform: rotate(270deg);
        }

        .card {
            padding: 10px 1px;
            background: #272c33 !important;
            color: white;
            margin-bottom: 10px !important;
        }

        #filter_div {
            padding: 10px;
            background: #272c33 !important;
            color: white;
        }

        .col-lg-12 {
            padding: 0px !important;
        }

        .col-lg-10 {
            padding: 0px !important;
        }

        .card-body {
            padding: 0rem !important;
        }

        .dt-buttons .dt-button {
            border-radius: 4px;
            background: orange;
            color: #ffffff
        }

        table.dataTable tbody tr {
            background-color: #272c33 !important;
            font-size: small;
            font-weight: normal;
        }

        table.dataTable tr.odd {
            background-color: #343a40 !important;
        }

        table.dataTable td {
            border-bottom: 0.2px !important;
            border-color: grey !important;
        }

        table.dataTable thead {
            color: #f6f5f5;
            font-weight: normal;
            font-size: small;
        }

        #shots_table_length, #shots_table_info, #shots_table_filter {
            color: #a2a1a1 !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 2px;
            background: white !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            color: #fff5f5 !important;
            background-color: #e5711d !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background-color: rgb(183, 110, 5) !important;
        }

        .dataTables_wrapper .dataTables_paginate .ellipsis {
            color: white;
        }

        tfoot input {
            width: 100% !important;
            padding: 3px !important;
            box-sizing: border-box !important;
        }

        table.dataTable tfoot th, table.dataTable tfoot td {
            padding: 5px;
            border-top: 0px;
        }

        .page-titles {
            padding-bottom: 0px;
        }

        .dataTables_wrapper .dataTables_length select {
            color: #ccc8c8 !important;
            background-color: inherit;
        }

        .dataTables_wrapper .dataTables_filter input {
            color: #dad8d8 !important;
        }


        table.dataTable tbody tr.selected {
            background-color: #315eb1 !important;
            color: white !important;
        }

        label {
            margin-bottom: 0px !important;
        }

        .multiselect-container > li > a > label {
            padding: 4px 20px 3px 20px;
        }

        table.dataTable tbody th, table.dataTable tbody td {
            padding: 7px;
        }

        .column_vis {
            height: 20px;
        }

        /* width */
        ::-webkit-scrollbar {
            width: 10px;
        }

        /* Track */
        ::-webkit-scrollbar-track {
            background: #383f48;
            border-radius: 5px;
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
            background: #2965b9;
            border-radius: 5px;
        }

        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }


        div.dtsp-verticalContainer {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-content: flex-start;
            align-items: flex-start;
        }

        div.dtsp-verticalContainer div.dtsp-verticalPanes,
        div.dtsp-verticalContainer div.container {
            width: 20%;
            flex-grow: 0;
            flex-shrink: 0;
            flex-basis: 0;
        }

        div.dtsp-verticalContainer div.dtsp-verticalPanes {
            flex-grow: 1;
            flex-shrink: 0;
            flex-basis: 26%;
        }

        div.dtsp-verticalPanes {
            margin-right: 10px;
        }

        div.dtsp-title {
            margin-right: 0px !important;
            margin-top: 13px !important;
        }

        input.dtsp-search {
            min-width: 0px !important;
            padding-left: 0px !important;
            margin: 0px !important;
        }

        div.dtsp-verticalContainer div.dtsp-verticalPanes div.dtsp-searchPanes {
            flex-direction: column;
            flex-basis: 0px;
        }

        div.dtsp-verticalContainer div.dtsp-verticalPanes div.dtsp-searchPanes div.dtsp-searchPane {
            flex-basis: 0px;
        }

        div.dtsp-verticalContainer div.container {
            flex-grow: 1;
            flex-shrink: 0;
            flex-basis: 80%;
        }

        div.dtsp-panesContainer {
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 5px;
        }

        select {
            -webkit-appearance: none;
        }

        div.dtsp-narrow {
            flex-direction: column !important;
            background-color: #343a40;
        }

        div.dtsp-panesContainer button.dtsp-clearAll, div.dtsp-panesContainer button.dtsp-collapseAll, div.dtsp-panesContainer button.dtsp-showAll {
            border: none;
            background-color: #343a40;
            padding: 3px;
            border-radius: 5px;
        }

        div.dtsp-panesContainer button.dtsp-disabledButton {
            cursor: default !important;
            background-color: #343a40;
            padding: 3px;
            border-radius: 10px;
            color: white;
        }

        div.dtsp-panesContainer div.dataTables_wrapper div.dataTables_scrollBody {
            background: #343a40 !important;
            border-bottom: none;
        }

        /* An ugly trick to use a filter icon */
        .ui-icon-volume-off.ui-icon-filter {
            -ms-transform: rotate(270deg);
            -webkit-transform: rotate(270deg);
            transform: rotate(270deg);
        }

        .modal.right .modal-dialog {
            position: fixed;
            margin: auto;
            width: 700px;
            height: 100%;
            -webkit-transform: translate3d(0%, 0, 0);
            -ms-transform: translate3d(0%, 0, 0);
            -o-transform: translate3d(0%, 0, 0);
            transform: translate3d(0%, 0, 0);
        }

        .modal.right .modal-content {
            height: 100%;
            overflow-y: auto;
        }

        .modal.right .modal-body {
            padding: 15px 15px 15px;
        }

        .modal.right.fade .modal-dialog {
            right: 0px;
            -webkit-transition: opacity 0.3s linear, right 0.3s ease-out;
            -moz-transition: opacity 0.3s linear, right 0.3s ease-out;
            -o-transition: opacity 0.3s linear, right 0.3s ease-out;
            transition: opacity 0.3s linear, right 0.3s ease-out;
        }

        .modal.right.fade.in .modal-dialog {
            right: 0;
        }

        /* ----- MODAL STYLE ----- */
        .modal-content {
            border-radius: 0;
            border: none;
        }

        .modal-header {
            border-bottom-color: #EEEEEE;
            background-color: #e5711d;
        }

        input.dtsp-search::placeholder {
            color: #a4a4a8 !important;
        }
    </style>
    <div class="row page-titles">
        <div class="col-md-6 mb-3 col-12 float-left">
            <h3 class="text-themecolor mb-0 mt-2">Notifications</h3>
        </div>
    </div>
    <!-- ============================================================== -->
    <!-- End Bread crumb and right sidebar toggle -->
    <!-- ============================================================== -->
{% endblock bread_crumb %}


{% block content %}
<div class="card" style="padding: 10px 15px;">
    <div class="card-body">
        <div class="row">
            <div class="col-8 pl-0">
                <div class="btn-group mb-2 mr-2" role="group" aria-label="Button group with nested dropdown">
                    <a href="#all" class="btn btn-secondary font-18 text-dark r-active" data-data="all"><i class="mdi mdi-email"></i> All</a>
                    <a href="#read" class="btn btn-secondary font-18 text-dark r-active" data-data="read"><i class="mdi mdi-email-open"></i> Read</a>
                    <a href="#unread" class="btn btn-secondary font-18 text-dark r-active" data-data="unread"><i class="mdi mdi-email"></i> Unread</a>
                </div>
                <div class="btn-group mb-2 mr-2" role="group" aria-label="Button group with nested dropdown">
                    <button type="button" class="btn btn-secondary font-18 text-dark make-all-read"><i class="mdi mdi-email-open"></i> Mark As All Read</button>
                </div>
                <div class="btn-group mb-2 mr-2" role="group" aria-label="Button group with nested dropdown">
                    <input type="date" name="from_date" class="btn btn-secondary" placeholder="dd/mm/yyyy">
                    <input type="date" name="to_date" class="btn btn-secondary" placeholder="dd/mm/yyyy">
                    <button type="button" class="btn btn-secondary font-18 text-dark run-filter"><i class="mdi mdi-arrow-right-bold"></i></button>
                </div>
            </div>
            <div class="col-4 pr-0 text-right">
                <div class="btn-group mb-2 mr-2" role="group" aria-label="Button group with nested dropdown">
                    <a href="/notifications/" class="btn btn-secondary mb-2 text-dark"><i class="mdi mdi-filter-remove font-18"></i></a>
                    <a href="#" class="btn btn-secondary mb-2 text-dark current-url"><i class="mdi mdi-reload font-18"></i></a>
                </div>
            </div>
        </div>
        <!-- <div class="btn-group mb-2 mr-2" role="group" aria-label="Button group with nested dropdown">
            <button type="button" class="btn btn-secondary font-18 text-dark"><i class="mdi mdi-inbox-arrow-down"></i></button>
            <button type="button" class="btn btn-secondary font-18 text-dark"><i class="mdi mdi-alert-octagon"></i></button>
            <button type="button" class="btn btn-secondary font-18 text-dark"><i class="mdi mdi-delete"></i></button>
        </div>
        <div class="btn-group mb-2 mr-2" role="group" aria-label="Button group with nested dropdown">
            <div class="btn-group" role="group">
                <button id="btnGroupDrop1" type="button" class="btn btn-secondary text-dark dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <i class="mdi mdi-folder font-18 "></i> </button>
                <div class="dropdown-menu" aria-labelledby="btnGroupDrop1"> <a class="dropdown-item" href="#">Dropdown link</a> <a class="dropdown-item" href="#">Dropdown link</a> </div>
            </div>
            <div class="btn-group" role="group">
                <button id="btnGroupDrop1" type="button" class="btn text-dark btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <i class="mdi mdi-label font-18"></i> </button>
                <div class="dropdown-menu" aria-labelledby="btnGroupDrop1"> <a class="dropdown-item" href="#">Dropdown link</a> <a class="dropdown-item" href="#">Dropdown link</a> </div>
            </div>
        </div> -->
    </div>
    <div class="card-body pt-0">
        <div class="card b-all shadow-none">
            <div class="inbox-center table-responsive">
                <table class="table table-hover no-wrap">
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block page_scripts %}
    <!--OFX Core JavaScript -->
    <script src="{% static static 'ofx/core' %}"></script>
    <!-- End Core Javascript -->
    <script src="{% static static 'template/assets/plugins/popper/popper.min' %}"></script>

    <script src="{% static 'third_party/DataTables/DataTables-1.12.1/js/jquery.dataTables.min' %}"></script>
    <script src="{% static 'third_party/DataTables/Responsive-2.3.0/js/dataTables.responsive.min' %}"></script>
    <script src="{% static 'third_party/DataTables/Responsive-2.3.0/js/responsive.bootstrap5.min' %}"></script>
    <script src="{% static 'third_party/DataTables/Buttons-2.2.3/js/dataTables.buttons.min' %}"></script>
    <script src="{% static 'third_party/DataTables/Buttons-2.2.3/js/buttons.html5.min' %}"></script>
    <script src="{% static 'third_party/DataTables/Bootstrap-5-5.1.3/js/bootstrap.bundle.min' %}"></script>
    <script src="{% static 'third_party/DataTables/custom_js/datatables_searchPane' %}"></script>
    <script src="{% static 'third_party/DataTables/Select-1.4.0/js/dataTables.select.min' %}"></script>
    <!-- <script src="{% static 'template/assets/plugins/moment/moment' %}"></script> -->
    <script src="{% static 'third_party/DataTables/DateTime-1.1.2/js/dataTables.dateTime.min' %}"></script>

    <script src="{% static 'main/jquery-ui.min' %}"></script>
    <script src="{% static 'main/jquery.ui-contextmenu.min' %}"></script>
    <script src="{% static 'main/dataTables.colReorder.min' %}"></script>
    <script src="{% static 'main/fnFilterClear' %}"></script>
    <script>
        $('.current-url').attr('href',window.location.href);
        function addNotif(parent,e){
            var inx = true;
            $.each(e.read_recipients,function(d,dx){
                if((typeof dx.id != "undefined" && dx.id==user_id)||dx==user_id){
                    inx = false;
                    }
                });
            let row = `<tr data-id="` + e.dataId + `" class="`+(inx?'unread':'')+`">
                            <td class="hidden-xs-down"><img src="` + ((e.from_user != null && typeof e.from_user.photo != "undefined")?e.from_user.photo:'/media/profiles/photo/default.png') + `" alt="` + ((e.from_user != null && typeof e.from_user.fullName != "undefined")?e.from_user.fullName:'Unknown User') + `" title="` + ((e.from_user != null && typeof e.from_user.fullName != "undefined")?e.from_user.fullName:'Unknown User') + `" onerror="this.src='/media/profiles/photo/default.png'" alt class="profile-pic" width="50" style="width: 12%;border-radius: 50%"> ` + ((e.from_user != null && typeof e.from_user.fullName != "undefined")?e.from_user.fullName:'Unknown User') + `</td>
                            <td class="max-texts"> <a href="/notifications/view/?data_id=` + e.dataId + `">` + (e.message_title!=null?'<span class="label mr-2">'+e.message_title+'</span>':'') + ` ` + e.message + `</a></td>
                            <td class="hidden-xs-down">`+ (e.attachments.length>0?'<i class="fa fa-paperclip"></i>':'') +`</td>
                            <td class="text-right">` + moment(e.creation_date).format("MMM Do YYYY, h:mm a") + `</td>
                        </tr> `;
            $(parent).append(row);
            }
        function setShowNofis(e){
            var rType = e;
            let parent = $('.inbox-center > table > tbody');
            $(parent).find('tr').each(function(e){
                if(rType=="all"||rType==""){
                    $(this).fadeIn('slow');
                    }else if(rType=='read'){
                        if($(this).hasClass('unread')){
                            $(this).fadeOut('slow');
                            }else{
                                $(this).fadeIn('slow');
                                }
                        }else if(rType=='unread'){
                            if($(this).hasClass('unread')){
                                $(this).fadeIn('slow');
                                }else{
                                    $(this).fadeOut('slow');
                                    }
                            }
                });
            var _xUrl = window.location.href.split("#");
            $('.current-url').attr('href',_xUrl[0]+(rType.length>0?'#'+rType:""));
            }

        var defaultDays = 7; //Days 
        var instelDate = moment().subtract(defaultDays,'d').format("YYYY-MM-DD");
        var type = window.location.hash.substring(1);
        var getKeys = getGetParam({'from_date':instelDate+'T00:00:00.000000','to_date':moment().format("YYYY-MM-DD")+'T23:59:59.999999'});
        var table_parent = $('.inbox-center > table > tbody');
        $(table_parent).html('');
        $.each(getKeys,function(x,e){
            $('input[name="'+x+'"]').attr("value",moment(e).format('YYYY-MM-DD'));
            });
        var getKeys2 = getGetParam({'from_date':null,'to_date':null});
        if(getKeys2['from_date']===null&&getKeys2['to_date']===null){
            $.ajax({
                url: '/api/notifications/',
                type: 'GET',
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                data: {
                    user_id: user_id,
                    read: 'False',
                    to_date: moment().subtract(defaultDays+1,'d').format("YYYY-MM-DD")+'T23:59:59.999999'
                    },
                success: function (response) {
                    $.each(response,function(z,e){
                        addNotif($(table_parent),e);
                        });
                    setShowNofis(type);
                },
                error: function (jqXHR, exception) {
                    console.log(jqXHR.responseText)
                }
            });
            // getKeys.read = 'False';
            }
        getKeys.user_id = user_id
        $.ajax({
            url: '/api/notifications/',
            type: 'GET',
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            data: getKeys,
            success: function (response) {
                $.each(response,function(z,e){
                    addNotif($(table_parent),e);
                    });
                setShowNofis(type);
            },
            error: function (jqXHR, exception) {
                console.log(jqXHR.responseText)
            }
        });
    $(document).on('click', 'a.current-url',function(e){
        location.reload();
        // console.log($(this).attr("href"));
        // window.location.href = $(this).attr("href");
        });
    $(document).on('click', 'a.r-active',function(e){
        setShowNofis($(this).attr("data-data"));
        });
    $(document).on('click', '.run-filter',function(e){
        var fil = [];
        $(this).parent().find('input').each(function(e){
            if($(this).val().length>0){
                if($(this).attr('name')==='from_date'){
                    fil.push($(this).attr('name')+'='+$(this).val()+'T00:00:00.000000');
                    }else if($(this).attr('name')==='to_date'){
                        fil.push($(this).attr('name')+'='+$(this).val()+'T23:59:59.999999');
                        }else{
                            fil.push($(this).attr('name')+'='+$(this).val());
                            }
                }
            });
        var lin = fil.join("&");
        let xv = window.location.hash.substring(1);
        if(xv.length>0){
            lin = lin+'#'+xv;
            }
        let url = '/notifications/'+(fil.length>0?'?':'')+lin;
        window.location = url;
        // console.log(url);
        });
    </script>
{% endblock page_scripts %}