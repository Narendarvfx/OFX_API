{% extends 'main/base.html' %}
{% load static %}
{% block bread_crumb %}

    <link rel='stylesheet' href="{% static 'third_party/DataTables/DataTables-1.12.1/css/jquery.dataTables.min.css' %}"
          type="text/css"/>
    <link rel='stylesheet' href="{% static 'third_party/DataTables/Responsive-2.3.0/css/responsive.dataTables.min.css' %}"
          type="text/css"/>
    <link rel='stylesheet' href="{% static 'third_party/DataTables/Responsive-2.3.0/css/responsive.bootstrap5.min.css' %}"
          type="text/css"/>
    <link rel='stylesheet' href="{% static 'third_party/DataTables/Buttons-2.2.3/css/buttons.dataTables.min.css' %}"
          type="text/css"/>
    <link rel='stylesheet' href="{% static 'template/assets/plugins/multiselect/css/multi-select.css' %}"
          type="text/css"/>
    <link rel="stylesheet"
          href="{% static 'third_party/DataTables/custom_css/datables_searchpane.css' %}" type="text/css"/>
    <link rel="stylesheet"
          href="{% static 'third_party/DataTables/Select-1.4.0/css/select.dataTables.min.css' %}" type="text/css"/>
    <link href="{% static 'third_party/DataTables/DataTables-1.12.1/css/dataTables.jqueryui.css' %}" rel="stylesheet"
          type="text/css"/>
    <link href="{% static 'third_party/DataTables/DateTime-1.1.2/css/dataTables.dateTime.min.css' %}" rel="stylesheet"
          type="text/css"/>
    <link href="{% static 'main/jquery-ui-themes-1.11.1/themes/south-street/jquery-ui.min.css' %}" rel="stylesheet" type="text/css"/>
    <link href="{% static 'main/dataTables.jqueryui.css' %}" rel="stylesheet" type="text/css"/>
    <link rel='stylesheet' href="{% static 'assets/css/style.css' %}" type="text/css"/>
    <style>
        .form-control {
            color: #fffcfc !important;
        }

        .container-fluid {
            padding: 10px !important;
        }

        .row {
            margin: 0px !important;
        }

        /* An ugly trick to use a filter icon */
        .ui-icon-volume-off.ui-icon-filter {
            -ms-transform: rotate(270deg);
            -webkit-transform: rotate(270deg);
            transform: rotate(270deg);
        }

        .card {
            padding: 10px 1px;
            background: #272c33 !important;
            color: white;
            margin-bottom: 10px !important;
        }

        #filter_div {
            padding: 10px;
            background: #272c33 !important;
            color: white;
        }

        .col-lg-12 {
            padding: 0px !important;
        }

        .col-lg-10 {
            padding: 0px !important;
        }

        .card-body {
            padding: 0rem !important;
        }

        .dt-buttons .dt-button {
            border-radius: 4px;
            background: orange;
            color: #ffffff
        }

        table.dataTable tbody tr {
            background-color: #272c33 !important;
            font-size: small;
            font-weight: normal;
        }

        table.dataTable tr.odd {
            background-color: #343a40 !important;
        }

        table.dataTable td {
            border-bottom: 0.2px !important;
            border-color: grey !important;
        }

        table.dataTable thead {
            color: #f6f5f5;
            font-weight: normal;
            font-size: small;
        }

        #shots_table_length, #shots_table_info, #shots_table_filter {
            color: #a2a1a1 !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 2px;
            background: white !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            color: #fff5f5 !important;
            background-color: #e5711d !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background-color: rgb(183, 110, 5) !important;
        }

        .dataTables_wrapper .dataTables_paginate .ellipsis {
            color: white;
        }

        tfoot input {
            width: 100% !important;
            padding: 3px !important;
            box-sizing: border-box !important;
        }

        table.dataTable tfoot th, table.dataTable tfoot td {
            padding: 5px;
            border-top: 0px;
        }

        .page-titles {
            padding-bottom: 0px;
        }

        .dataTables_wrapper .dataTables_length select {
            color: #ccc8c8 !important;
            background-color: inherit;
        }

        .dataTables_wrapper .dataTables_filter input {
            color: #dad8d8 !important;
        }


        table.dataTable tbody tr.selected {
            background-color: #315eb1 !important;
            color: white !important;
        }

        label {
            margin-bottom: 0px !important;
        }

        .multiselect-container > li > a > label {
            padding: 4px 20px 3px 20px;
        }

        table.dataTable tbody th, table.dataTable tbody td {
            padding: 7px;
        }

        .column_vis {
            height: 20px;
        }

        /* width */
        ::-webkit-scrollbar {
            width: 10px;
        }

        /* Track */
        ::-webkit-scrollbar-track {
            background: #383f48;
            border-radius: 5px;
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
            background: #2965b9;
            border-radius: 5px;
        }

        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }


        div.dtsp-verticalContainer {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-content: flex-start;
            align-items: flex-start;
        }

        div.dtsp-verticalContainer div.dtsp-verticalPanes,
        div.dtsp-verticalContainer div.container {
            width: 20%;
            flex-grow: 0;
            flex-shrink: 0;
            flex-basis: 0;
        }

        div.dtsp-verticalContainer div.dtsp-verticalPanes {
            flex-grow: 1;
            flex-shrink: 0;
            flex-basis: 26%;
        }

        div.dtsp-verticalPanes {
            margin-right: 10px;
        }

        div.dtsp-title {
            margin-right: 0px !important;
            margin-top: 13px !important;
        }

        input.dtsp-search {
            min-width: 0px !important;
            padding-left: 0px !important;
            margin: 0px !important;
        }

        div.dtsp-verticalContainer div.dtsp-verticalPanes div.dtsp-searchPanes {
            flex-direction: column;
            flex-basis: 0px;
        }

        div.dtsp-verticalContainer div.dtsp-verticalPanes div.dtsp-searchPanes div.dtsp-searchPane {
            flex-basis: 0px;
        }

        div.dtsp-verticalContainer div.container {
            flex-grow: 1;
            flex-shrink: 0;
            flex-basis: 80%;
        }

        div.dtsp-panesContainer {
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 5px;
        }

        select {
            -webkit-appearance: none;
        }

        div.dtsp-narrow {
            flex-direction: column !important;
            background-color: #343a40;
        }

        div.dtsp-panesContainer button.dtsp-clearAll, div.dtsp-panesContainer button.dtsp-collapseAll, div.dtsp-panesContainer button.dtsp-showAll {
            border: none;
            background-color: #343a40;
            padding: 3px;
            border-radius: 5px;
        }

        div.dtsp-panesContainer button.dtsp-disabledButton {
            cursor: default !important;
            background-color: #343a40;
            padding: 3px;
            border-radius: 10px;
            color: white;
        }

        div.dtsp-panesContainer div.dataTables_wrapper div.dataTables_scrollBody {
            background: #343a40 !important;
            border-bottom: none;
        }

        /* An ugly trick to use a filter icon */
        .ui-icon-volume-off.ui-icon-filter {
            -ms-transform: rotate(270deg);
            -webkit-transform: rotate(270deg);
            transform: rotate(270deg);
        }

        .modal.right .modal-dialog {
            position: fixed;
            margin: auto;
            width: 700px;
            height: 100%;
            -webkit-transform: translate3d(0%, 0, 0);
            -ms-transform: translate3d(0%, 0, 0);
            -o-transform: translate3d(0%, 0, 0);
            transform: translate3d(0%, 0, 0);
        }

        .modal.right .modal-content {
            height: 100%;
            overflow-y: auto;
        }

        .modal.right .modal-body {
            padding: 15px 15px 15px;
        }

        .modal.right.fade .modal-dialog {
            right: 0px;
            -webkit-transition: opacity 0.3s linear, right 0.3s ease-out;
            -moz-transition: opacity 0.3s linear, right 0.3s ease-out;
            -o-transition: opacity 0.3s linear, right 0.3s ease-out;
            transition: opacity 0.3s linear, right 0.3s ease-out;
        }

        .modal.right.fade.in .modal-dialog {
            right: 0;
        }

        /* ----- MODAL STYLE ----- */
        .modal-content {
            border-radius: 0;
            border: none;
        }

        .modal-header {
            border-bottom-color: #EEEEEE;
            background-color: #e5711d;
        }

        input.dtsp-search::placeholder {
            color: #a4a4a8 !important;
        }
    </style>
    <div class="row page-titles">
        <div class="col-md-6 mb-3 col-12 float-left">
            <h3 class="text-themecolor mb-0 mt-2">Notifications</h3>
        </div>
    </div>
    
{% endblock bread_crumb %}


{% block content %}
    <div class="card" style="padding: 10px 15px;">
        <div class="card-body pt-0">
            <div class="card b-all shadow-none">
                <div class="card-body">
                    <h3 class="card-title mb-0 pt-2 pb-3 pl-3 pr-3 msg-title"></h3>
                </div>
                <div>
                    <hr class="mt-0 mb-0">
                </div>
                <div class="row">
                    <div class="col-md-6 pt-3">
                        <div class="card-body ml-3 mr-3">
                            <div class="d-flex mb-5">
                                <div>
                                    <div class="btn btn-circle" style="padding:0px;">
                                        <img class="user-image profile-pic" src="{{ user.employee.photo.url }}" alt="" title="" onerror="this.src='https://shotbuzz-dev.s3.ap-south-1.amazonaws.com/media/profiles/photo/default.png'" width="50" style="width: 100%;border-radius: 50%">
                                    </div>
                                </div>
                                <div class="pl-2">
                                    <h4 class="mb-0 user-name"></h4>
                                    <small class="text-muted c-date"></small>
                                </div>
                            </div>
                            <p class="msg-body"></p>
                        </div>
                    </div>
                    <div class="col-md-6 pt-3 pl-0 pr-0" style="border-left: 1px solid rgba(0, 0, 0, 0.4) !important;">
                        <div class="card pb-0" style="margin-bottom: 0px!important;">
                            <div class="card-body">
                                <h4 class="card-title pl-3 pr-3 pb-1"><span class="shot-name" style="width: calc(100% - 100px);display: inline-block;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;"></span><a href="#" class="btn btn-info shot-link" style="float: right; margin-top: -10px;">Know More</a></h4>
                                <!-- <h4 class="card-title shot-name"></h4>
                                <h6 class="card-subtitle"><a href="#">Know More</a></h6> -->
                                <div class="table-responsive">
                                    <table class="table no-wrap mb-0 shot-info">
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <hr class="mt-0">
                </div>
                <div class="card-body ml-3 mr-3 files"></div>
            </div>
        </div>
    </div>

{% endblock content %}

{% block page_scripts %}
    <!--OFX Core JavaScript -->
    <script src="{% static 'ofx/core.js' %}"></script>
    <!-- End Core Javascript -->
    <script src="{% static 'template/assets/plugins/popper/popper.min.js' %}"></script>

    <script src="{% static 'third_party/DataTables/DataTables-1.12.1/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'third_party/DataTables/Responsive-2.3.0/js/dataTables.responsive.min.js' %}"></script>
    <script src="{% static 'third_party/DataTables/Responsive-2.3.0/js/responsive.bootstrap5.min.js' %}"></script>
    <script src="{% static 'third_party/DataTables/Buttons-2.2.3/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'third_party/DataTables/Buttons-2.2.3/js/buttons.html5.min.js' %}"></script>
    <script src="{% static 'third_party/DataTables/Bootstrap-5-5.1.3/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'third_party/DataTables/custom_js/datatables_searchPane.js' %}"></script>
    <script src="{% static 'third_party/DataTables/Select-1.4.0/js/dataTables.select.min.js' %}"></script>
    <!-- <script src="{% static 'template/assets/plugins/moment/moment.js' %}"></script> -->
    <script src="{% static 'third_party/DataTables/DateTime-1.1.2/js/dataTables.dateTime.min.js' %}"></script>

    <script src="{% static 'main/jquery-ui.min.js' %}"></script>
    <script src="{% static 'main/jquery.ui-contextmenu.min.js' %}"></script>
    <script src="{% static 'main/dataTables.colReorder.min.js' %}"></script>
    <script src="{% static 'main/fnFilterClear.js' %}"></script>
    <script>
        
        function setPagedata(e){
            let img = $('.user-image'), uname = $('.user-name'), cdate = $('.c-date');
            $('.user-image').attr({'src':e.from_user.photo,'alt':e.from_user.fullName,'title':e.from_user.fullName});
            $('.msg-title').html((e.message_title!=null?e.message_title:e.from_user.fullName));
            $('.user-name').html(e.from_user.fullName);
            $('.msg-body').html(e.message);
            $('.c-date').html(moment(e.creation_date).format("MMM Do YYYY, h:mm a"));
            let files = '';
            if(e.attachments.length>0){
                let row = {'images':'','files':''};
                $.each(e.attachments, function (z, xe) {
                    if($.inArray(xe.file_type,['png','jpg','jpeg'])!=-1){
                        row['images'] = row['images']+`<div class="col-md-2">
                                                            <a class="btn waves-effect waves-light btn-block btn-dark" href="/attachments/notes/download/` + xe.id + `" title="` + xe.file_name + `">
                                                                <img class="img-thumbnail img-responsive" alt="attachment" src="`+xe.files+`" style="height: 110px;width: auto;max-width: 100%;max-height: initial;margin-top: 24px;">
                                                                <p style="display: block;">
                                                                    <span class="file-name" style=" white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">` + xe.file_name + `</span>
                                                                    <span class="file-info">
                                                                        <i>` + formatBytes(xe.file_size, 2) + `</i>
                                                                    </span>
                                                                </p>
                                                            </a>
                                                        </div>`;
                        }else{
                            row['files'] = row['files']+`<div class="col-md-2">
                                                            <a class="btn waves-effect waves-light btn-block btn-dark" href="/attachments/notes/download/` + xe.id + `" title="` + xe.file_name + `">
                                                                <p class="fas ` + (typeof fas_file_icons[xe.file_type] != "undefined" ? fas_file_icons[xe.file_type] : fas_file_icons['default']) + `" style="position: relative;margin: auto; font-size: 100px;padding-top: 24px;width: inherit;"></p>
                                                                <p style="display: block;">
                                                                    <span class="file-name" style=" white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">` + xe.file_name + `</span>
                                                                    <span class="file-info">
                                                                        <i>` + formatBytes(xe.file_size, 2) + `</i>
                                                                    </span>
                                                                </p>
                                                            </a>
                                                        </div>`;
                            }
                    });
                files = ((row['images'].length>0||row['files'].length>0)?`<div class="row file-x">`+row['images']+row['files']+`</div>`:'');
                }
            $('.files').append(`<h4><i class="fa fa-paperclip mr-2 mb-2"></i> Attachments <span>(`+e.attachments.length+`)</span></h4>`+files);
            $('.shot-name').html(e.shotInfo.name);
            let tbx = [
                    {name: "client", title: "CLIENT", data: e.shotInfo.sequence.project.client.name},
                    {name: "project", title: "PROJECT", data: e.shotInfo.sequence.project.name},
                    {name: "seq", title: "SEQUENCE", data: e.shotInfo.sequence.name},
                    {name: "shot", title: "SHOT CODE", data: e.shotInfo.name},
                    {name: "task_type", title: "TASK TYPE", data: e.shotInfo.task_type},
                    {name: "type", title: "TYPE", data: e.shotInfo.type},
                    {name: "status", title: "STATUS", data: '<span class="badge" style="color:white;padding:3px 10px;font-size:1em; background-color:' + e.shotInfo.status.color + '">' + e.shotInfo.status.code + '</span>'},
                    {name: "team_lead", title: "TEAM LEAD", data: e.shotInfo.team_lead},
                    {name: "artist", title: "ARTIST", data: e.shotInfo.artist},
                    {name: "version", title: "VERSION", data: e.shotInfo.version===null?"N/A":e.shotInfo.version},
                ];
            var trx = '';
            $.each(tbx,function(zz,xx){ trx = trx+`<tr><td><strong>`+xx.title+`</strong></td><td>`+xx.data+`</td></tr>`; });
            $('.shot-info > tbody').html(trx);
            $('.shot-link').attr('href','/production/shots/view/?shot_id='+e.shotInfo.id);
            }
        var getKeys = getGetParam({'data_id':null});
        var notify = {};
        if(getKeys.data_id===null){
            window.location = '/notifications/';
            }else{
                $.ajax({
                    url: '/api/wsnotifications/notes/details/',
                    type: 'GET',
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    data: getKeys,
                    success: function (response) {
                        notify = response;
                        if(typeof response.referenceId != "undefined"){
                            $.ajax({
                                url: '/api/notifications/?user_id='+user_id+'&data_id='+response.dataId,
                                type: 'PUT',
                                dataType: "json",
                                contentType: 'application/json; charset=utf-8',
                                data: JSON.stringify({
                                    // user_id: user_id,
                                    // data_id: $(msgRo).attr('data-id'),
                                    read: true
                                    }),
                                success: function (x) { },
                                error: function (jqXHR, exception) {
                                    console.log(jqXHR.responseText)
                                }
                            });
                            $.ajax({
                                url: '/api/production/shots/'+response.referenceId+'/',
                                type: 'GET',
                                dataType: "json",
                                contentType: 'application/json; charset=utf-8',
                                // data: getKeys,
                                success: function (response) {
                                    if(typeof response.id != "undefined"){
                                        notify.shotInfo = response;
                                        setPagedata(notify);
                                        }else{
                                            window.location = '/notifications/';
                                            }
                                },
                                error: function (jqXHR, exception) {
                                    console.log(jqXHR.responseText)
                                }
                            });
                        }else{
                            window.location = '/notifications/';
                            }
                    },
                    error: function (jqXHR, exception) {
                        console.log(jqXHR.responseText)
                    }
                });
            }
    
        /*
        function addNotif(parent,e){
            var inx = true;
            $.each(e.read_recipients,function(d,dx){
                if((typeof dx.id != "undefined" && dx.id==user_id)||dx==user_id){
                    inx = false;
                    }
                });
            let row = `<tr data-id="` + e.dataId + `" class="`+(inx?'unread':'')+`">
                            <td class="hidden-xs-down">
                                <div class="btn btn-info btn-circle" style="padding:0px;">
                                    <img src="` + e.from_user.photo + `" alt="` + e.from_user.fullName + `" title="` + e.from_user.fullName + `" onerror="this.src='/media/profiles/photo/default.png'" width="50" style="width: 100%;">
                                </div>
                            </td>
                            <td class="hidden-xs-down">` + e.from_user.fullName + `</td>
                            <td class="max-texts"> <a href="/notifications/view/?data_id=` + e.dataId + `">` + (e.message_title!=null?'<span class="label mr-2">'+e.message_title+'</span>':'') + ` ` + e.message + `</a></td>
                            <td class="hidden-xs-down">`+ (e.attachments.length>0?'<i class="fa fa-paperclip"></i>':'') +`</td>
                            <td class="text-right">` + moment(e.creation_date).format("MMM Do YYYY, h:mm a") + `</td>
                        </tr> `;
            $(parent).append(row);
            }
        function setShowNofis(e){
            var rType = e;
            let parent = $('.inbox-center > table > tbody');
            $(parent).find('tr').each(function(e){
                if(rType=="all"||rType==""){
                    $(this).fadeIn('slow');
                    }else if(rType=='read'){
                        if($(this).hasClass('unread')){
                            $(this).fadeOut('slow');
                            }else{
                                $(this).fadeIn('slow');
                                }
                        }else if(rType=='unread'){
                            if($(this).hasClass('unread')){
                                $(this).fadeIn('slow');
                                }else{
                                    $(this).fadeOut('slow');
                                    }
                            }
                }); 
            }

        
        var type = window.location.hash.substring(1);
        var getKeys = getGetParam({'from_date':moment().format("YYYY-MM-DD")+'T00:00:00.000000','to_date':moment().format("YYYY-MM-DD")+'T23:59:59.999999'});
        $.each(getKeys,function(x,e){
            $('input[name="'+x+'"]').attr("value",moment(e).format('YYYY-MM-DD'));
            });
        var getKeys2 = getGetParam({'from_date':null,'to_date':null});
        if(getKeys2['from_date']===null&&getKeys2['to_date']===null){
            getKeys = {'read':'False'};
            }
        getKeys.user_id = user_id
        $.ajax({
            url: '/api/notifications/',
            type: 'GET',
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            data: getKeys,
            success: function (response) {
                let parent = $('.inbox-center > table > tbody');
                $(parent).html('');
                $.each(response,function(z,e){
                    addNotif($(parent),e);
                    });
                setShowNofis(type);
            },
            error: function (jqXHR, exception) {
                console.log(jqXHR.responseText)
            }
        });
    $(document).on('click', 'a.r-active',function(e){
        setShowNofis($(this).attr("data-data"));
        });
    $(document).on('click', '.run-filter',function(e){
        var fil = [];
        $(this).parent().find('input').each(function(e){
            if($(this).val().length>0){
                if($(this).attr('name')==='from_date'){
                    fil.push($(this).attr('name')+'='+$(this).val()+'T00:00:00.000000');
                    }else if($(this).attr('name')==='to_date'){
                        fil.push($(this).attr('name')+'='+$(this).val()+'T23:59:59.999999');
                        }else{
                            fil.push($(this).attr('name')+'='+$(this).val());
                            }
                }
            });
        var lin = fil.join("&");
        let xv = window.location.hash.substring(1);
        if(xv.length>0){
            lin = lin+'#'+xv;
            }
        let url = '/notifications/'+(fil.length>0?'?':'')+lin;
        window.location = url;
        // console.log(url);
        });
    */
    </script>
{% endblock page_scripts %}